<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>我是首頁</title>
</head>
<body>
    <h1>嗨</h1>
    <input id="msg">
    <button id="submit">送出</button>
    <h3>訊息們</h3>
    <ul id="msglist">
    </ul>

    <script type="text/javascript" src="http://chengxianga2008.github.com/node-cryptojs-aes/client/aes.js"></script>
    <script type="text/javascript" src="http://chengxianga2008.github.com/node-cryptojs-aes/client/jsonformatter.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script>
        $(document).ready(() => {
            let secret;

            let socket = io('http://localhost:3000');
            $("#submit").click(() => {
                let plainMsg = $('#msg').val();
                let encrypted = CryptoJS.AES.encrypt(plainMsg, secret, { format: JsonFormatter }).toString();
                socket.emit('msg', encrypted);
            });

            socket.on('secret', (sc) => {
                secret = sc;
            });

            socket.on('msg', (msg) => {
                let decrypt = CryptoJS.AES.decrypt(msg, secret, { format: JsonFormatter });
                let decrypted_str = "";
                try{
                    decrypted_str = CryptoJS.enc.Utf8.stringify(decrypt);
                }
                catch(e){}
                finally{
                    if(decrypted_str == ""){
                        decrypted_str = "!!無法解密訊息!!";
                    }
                }
                $('<li>').text(decrypted_str).prependTo($('#msglist'));
            });
        });
    </script>
</body>
</html>